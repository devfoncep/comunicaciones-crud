package co.f28smart.sgd.crud.utils;


import java.util.ArrayList;
import java.util.Iterator;
import java.util.List;
import java.util.Map;

import javax.faces.component.UIComponent;

import javax.faces.context.FacesContext;
import javax.faces.model.SelectItem;

import oracle.adf.model.BindingContext;
import oracle.adf.model.binding.DCBindingContainer;
import oracle.adf.model.binding.DCIteratorBinding;
import oracle.adf.model.binding.DCParameter;
import oracle.adf.share.logging.ADFLogger;

import oracle.adf.view.rich.context.AdfFacesContext;

import oracle.binding.AttributeBinding;
import oracle.binding.BindingContainer;
import oracle.binding.ControlBinding;
import oracle.binding.OperationBinding;

import oracle.jbo.ApplicationModule;
import oracle.jbo.Key;
import oracle.jbo.Row;
import oracle.jbo.uicli.binding.JUCtrlValueBinding;

public class ADFUtils {
   
    public static final ADFLogger LOGGER = ADFLogger.createADFLogger(ADFUtils.class);

        public ADFUtils() {
        }

        /**
         * Execute an operation binding in the current binding container by operation name.
         * @param operationBinding operation binding name
         * @return operation binding execution result
         */
        public static Object executeOperationBinding(String operationBinding) {
            return findOperation(operationBinding).execute();
        }

        /**
         * Get application module for an application module data control by name.
         * @param name application module data control name
         * @return ApplicationModule
         */
        public static ApplicationModule getApplicationModuleForDataControl(String name) {
            return (ApplicationModule) JsfUtil.resolveExpression("#{data." + name + ".dataProvider}");
        }

        /**
         * A convenience method for getting the value of a bound attribute in the
         * current page context programatically.
         * @param attributeName of the bound value in the pageDef
         * @return value of the attribute
         */
        public static Object getBoundAttributeValue(String attributeName) {
            return findControlBinding(attributeName).getInputValue();
        }

        /**
         * A convenience method for setting the value of a bound attribute in the
         * context of the current page.
         * @param attributeName of the bound value in the pageDef
         * @param value to set
         */
        public static void setBoundAttributeValue(String attributeName, Object value) {
            findControlBinding(attributeName).setInputValue(value);
        }


        /**
         * Convenience method to find a DCControlBinding as an AttributeBinding
         * to get able to then call getInputValue() or setInputValue() on it.
         * @param bindingContainer binding container
         * @param attributeName name of the attribute binding.
         * @return the control value binding with the name passed in.
         *
         */
        public static AttributeBinding findControlBinding(BindingContainer bindingContainer, String attributeName) {
            if (attributeName != null) {
                if (bindingContainer != null) {
                    ControlBinding ctrlBinding = bindingContainer.getControlBinding(attributeName);
                    if (ctrlBinding instanceof AttributeBinding) {
                        return (AttributeBinding) ctrlBinding;
                    }
                }
            }
            return null;
        }

        /**
         * Convenience method to find a DCControlBinding as a JUCtrlValueBinding
         * to get able to then call getInputValue() or setInputValue() on it.
         * @param attributeName name of the attribute binding.
         * @return the control value binding with the name passed in.
         *
         */
        public static AttributeBinding findControlBinding(String attributeName) {
            return findControlBinding(getBindingContainer(), attributeName);
        }

        /**
         * Return the current page's binding container.
         * @return the current page's binding container
         */
        public static BindingContainer getBindingContainer() {
            return (BindingContainer) JsfUtil.resolveExpression("#{bindings}");
        }

        /**
         * Return the Binding Container as a DCBindingContainer.
         * @return current binding container as a DCBindingContainer
         */
        public static DCBindingContainer getDCBindingContainer() {
            return (DCBindingContainer) getBindingContainer();
        }

        /**
         * Get List of ADF Faces SelectItem for an iterator binding.
         *
         * Uses the value of the 'valueAttrName' attribute as the key for
         * the SelectItem key.
         *
         * @param iteratorName ADF iterator binding name
         * @param valueAttrName name of the value attribute to use
         * @param displayAttrName name of the attribute from iterator rows to display
         * @return ADF Faces SelectItem for an iterator binding
         */
        public static List<SelectItem> selectItemsForIterator(String iteratorName, String valueAttrName,
                                                              String displayAttrName) {
            return selectItemsForIterator(findIterator(iteratorName), valueAttrName, displayAttrName);
        }

        /**
         * Get List of ADF Faces SelectItem for an iterator binding with description.
         *
         * Uses the value of the 'valueAttrName' attribute as the key for
         * the SelectItem key.
         *
         * @param iteratorName ADF iterator binding name
         * @param valueAttrName name of the value attribute to use
         * @param displayAttrName name of the attribute from iterator rows to display
         * @param descriptionAttrName name of the attribute to use for description
         * @return ADF Faces SelectItem for an iterator binding with description
         */
        public static List<SelectItem> selectItemsForIterator(String iteratorName, String valueAttrName,
                                                              String displayAttrName, String descriptionAttrName) {
            return selectItemsForIterator(findIterator(iteratorName), valueAttrName, displayAttrName, descriptionAttrName);
        }

        /**
         * Get List of attribute values for an iterator.
         * @param iteratorName ADF iterator binding name
         * @param valueAttrName value attribute to use
         * @return List of attribute values for an iterator
         */
        public static List attributeListForIterator(String iteratorName, String valueAttrName) {
            return attributeListForIterator(findIterator(iteratorName), valueAttrName);
        }

        /**
         * Get List of Key objects for rows in an iterator.
         * @param iteratorName iterabot binding name
         * @return List of Key objects for rows
         */
        public static List<Key> keyListForIterator(String iteratorName) {
            return keyListForIterator(findIterator(iteratorName));
        }

        /**
         * Get List of Key objects for rows in an iterator.
         * @param iter iterator binding
         * @return List of Key objects for rows
         */
        public static List<Key> keyListForIterator(DCIteratorBinding iter) {
            List<Key> attributeList = new ArrayList<Key>();
            for (Row r : iter.getAllRowsInRange()) {
                attributeList.add(r.getKey());
            }
            return attributeList;
        }

        /**
         * Get List of Key objects for rows in an iterator using key attribute.
         * @param iteratorName iterator binding name
         * @param keyAttrName name of key attribute to use
         * @return List of Key objects for rows
         */
        public static List<Key> keyAttrListForIterator(String iteratorName, String keyAttrName) {
            return keyAttrListForIterator(findIterator(iteratorName), keyAttrName);
        }

        /**
         * Get List of Key objects for rows in an iterator using key attribute.
         *
         * @param iter iterator binding
         * @param keyAttrName name of key attribute to use
         * @return List of Key objects for rows
         */
        public static List<Key> keyAttrListForIterator(DCIteratorBinding iter, String keyAttrName) {
            List<Key> attributeList = new ArrayList<Key>();
            for (Row r : iter.getAllRowsInRange()) {
                attributeList.add(new Key(new Object[] { r.getAttribute(keyAttrName) }));
            }
            return attributeList;
        }

        /**
         * Get a List of attribute values for an iterator.
         *
         * @param iter iterator binding
         * @param valueAttrName name of value attribute to use
         * @return List of attribute values
         */
        public static List attributeListForIterator(DCIteratorBinding iter, String valueAttrName) {
            List attributeList = new ArrayList();
            for (Row r : iter.getAllRowsInRange()) {
                attributeList.add(r.getAttribute(valueAttrName));
            }
            return attributeList;
        }

        /**
         * Find an iterator binding in the current binding container by name.
         *
         * @param iteratorName iterator binding name
         * @return iterator binding
         */
        public static DCIteratorBinding findIterator(String iteratorName) {
            DCIteratorBinding iter = getDCBindingContainer().findIteratorBinding(iteratorName);
            if (iter == null) {
                throw new RuntimeException("Iterator '" + iteratorName + "' not found");
            }
            return iter;
        }

        public static DCIteratorBinding findIterator(String bindingContainer, String iteratorName) {
            DCBindingContainer bindings = (DCBindingContainer) JsfUtil.resolveExpression("#{" + bindingContainer + "}");
            if (bindings == null) {
                throw new RuntimeException("Binding container '" + bindingContainer + "' not found");
            }
            DCIteratorBinding iter = bindings.findIteratorBinding(iteratorName);
            if (iter == null) {
                throw new RuntimeException("Iterator '" + iteratorName + "' not found");
            }
            return iter;
        }

        public static JUCtrlValueBinding findCtrlBinding(String ctrlBindingName) {
            JUCtrlValueBinding rowBinding = (JUCtrlValueBinding) getDCBindingContainer().findCtrlBinding(ctrlBindingName);
            if (rowBinding == null) {
                throw new RuntimeException("CtrlBinding " + ctrlBindingName + "' not found");
            }
            return rowBinding;
        }

        /**
         * Find an operation binding in the current binding container by name.
         * @param operationName operation binding name
         * @return operation binding
         */
        public static OperationBinding findOperation(String operationName) {
            OperationBinding op = getDCBindingContainer().getOperationBinding(operationName);
            if (op == null) {
                throw new RuntimeException("Operation '" + operationName + "' not found");
            }
            return op;
        }

        /**
         * Find an operation binding in the current binding container by name.
         *
         * @param bindingContianer binding container name
         * @param operationName operation binding name
         * @return operation binding
         */
        public static OperationBinding findOperation(String bindingContianer, String operationName) {
            DCBindingContainer bindings = (DCBindingContainer) JsfUtil.resolveExpression("#{" + bindingContianer + "}");
            if (bindings == null) {
                throw new RuntimeException("Binding container '" + bindingContianer + "' not found");
            }
            OperationBinding op = bindings.getOperationBinding(operationName);
            if (op == null) {
                throw new RuntimeException("Operation '" + operationName + "' not found");
            }
            return op;
        }

        /**
         * Get List of ADF Faces SelectItem for an iterator binding with description.
         *
         * Uses the value of the 'valueAttrName' attribute as the key for
         * the SelectItem key.
         *
         * @param iter ADF iterator binding
         * @param valueAttrName name of value attribute to use for key
         * @param displayAttrName name of the attribute from iterator rows to display
         * @param descriptionAttrName name of the attribute for description
         * @return ADF Faces SelectItem for an iterator binding with description
         */
        public static List<SelectItem> selectItemsForIterator(DCIteratorBinding iter, String valueAttrName,
                                                              String displayAttrName, String descriptionAttrName) {
            List<SelectItem> selectItems = new ArrayList<SelectItem>();
            for (Row r : iter.getAllRowsInRange()) {
                selectItems.add(new SelectItem(r.getAttribute(valueAttrName), (String) r.getAttribute(displayAttrName),
                                               (String) r.getAttribute(descriptionAttrName)));
            }
            return selectItems;
        }

        /**
         * Get List of ADF Faces SelectItem for an iterator binding.
         *
         * Uses the value of the 'valueAttrName' attribute as the key for
         * the SelectItem key.
         *
         * @param iter ADF iterator binding
         * @param valueAttrName name of value attribute to use for key
         * @param displayAttrName name of the attribute from iterator rows to display
         * @return ADF Faces SelectItem for an iterator binding
         */
        public static List<SelectItem> selectItemsForIterator(DCIteratorBinding iter, String valueAttrName,
                                                              String displayAttrName) {
            List<SelectItem> selectItems = new ArrayList<SelectItem>();
            for (Row r : iter.getAllRowsInRange()) {
                selectItems.add(new SelectItem(r.getAttribute(valueAttrName), (String) r.getAttribute(displayAttrName)));
            }
            return selectItems;
        }

        /**
         * Get List of ADF Faces SelectItem for an iterator binding.
         *
         * Uses the rowKey of each row as the SelectItem key.
         *
         * @param iteratorName ADF iterator binding name
         * @param displayAttrName name of the attribute from iterator rows to display
         * @return ADF Faces SelectItem for an iterator binding
         */
        public static List<SelectItem> selectItemsByKeyForIterator(String iteratorName, String displayAttrName) {
            return selectItemsByKeyForIterator(findIterator(iteratorName), displayAttrName);
        }

        /**
         * Get List of ADF Faces SelectItem for an iterator binding with discription.
         *
         * Uses the rowKey of each row as the SelectItem key.
         *
         * @param iteratorName ADF iterator binding name
         * @param displayAttrName name of the attribute from iterator rows to display
         * @param descriptionAttrName name of the attribute for description
         * @return ADF Faces SelectItem for an iterator binding with discription
         */
        public static List<SelectItem> selectItemsByKeyForIterator(String iteratorName, String displayAttrName,
                                                                   String descriptionAttrName) {
            return selectItemsByKeyForIterator(findIterator(iteratorName), displayAttrName, descriptionAttrName);
        }

        /**
         * Get List of ADF Faces SelectItem for an iterator binding with discription.
         *
         * Uses the rowKey of each row as the SelectItem key.
         *
         * @param iterator ADF iterator binding
         * @param displayAttrName name of the attribute from iterator rows to display
         * @param descriptionAttrName name of the attribute for description
         * @return ADF Faces SelectItem for an iterator binding with discription
         */
        public static List<SelectItem> selectItemsByKeyForIterator(DCIteratorBinding iterator, String displayAttrName,
                                                                   String descriptionAttrName) {
            List<SelectItem> selectItems = new ArrayList<SelectItem>();
            for (Row r : iterator.getAllRowsInRange()) {
                selectItems.add(new SelectItem(r.getKey(), (String) r.getAttribute(displayAttrName),
                                               (String) r.getAttribute(descriptionAttrName)));
            }
            return selectItems;
        }

        /**
         * Get List of ADF Faces SelectItem for an iterator binding.
         *
         * Uses the rowKey of each row as the SelectItem key.
         *
         * @param iterator ADF iterator binding
         * @param displayAttrName name of the attribute from iterator rows to display
         * @return List of ADF Faces SelectItem for an iterator binding
         */
        public static List<SelectItem> selectItemsByKeyForIterator(DCIteratorBinding iterator, String displayAttrName) {
            List<SelectItem> selectItems = new ArrayList<SelectItem>();
            for (Row r : iterator.getAllRowsInRange()) {
                selectItems.add(new SelectItem(r.getKey(), (String) r.getAttribute(displayAttrName)));
            }
            return selectItems;
        }

       

        public static void printOperationBindingExceptions(List operationsList) {
            if (operationsList != null && !operationsList.isEmpty()) {
                for (Object error : operationsList) {
                    LOGGER.severe(error.toString());
                }
            }
        }

        public static Object getPageFlowScopeAttribute(String key) {
            AdfFacesContext adfFacesCtx = AdfFacesContext.getCurrentInstance();
            return adfFacesCtx.getPageFlowScope().get(key);
        }

        public static void putPageFlowScopeAttribute(String key, Object value) {
            AdfFacesContext.getCurrentInstance()
                           .getPageFlowScope()
                           .put(key, value);
            //AdfFacesContext adfFacesCtx = AdfFacesContext.getCurrentInstance();
            //adfFacesCtx.getPageFlowScope().put(key,value);
        }

        // Refresh the Component

        public static void refreshComponent(UIComponent component) {
            if (component != null) {
                AdfFacesContext.getCurrentInstance().addPartialTarget(component);
            }
        }


        public static Object executeOperationBinding(String methodAction, Map param) {
            OperationBinding ob = ADFUtils.findOperation(methodAction);

            if (param != null) {
                Map paramOps = ob.getParamsMap();
                paramOps.putAll(param);
            }
            Object result = ob.execute();
            return result;
        }
        public static UIComponent getUIComponent(String id) { 
               
                FacesContext facesCtx = FacesContext.getCurrentInstance(); 
                return findComponent(facesCtx.getViewRoot(), id);
            } 
           
        public static UIComponent findComponent(UIComponent base, String id) {
           
            if (id.equals(base.getId())) {
                return base;
            }

            UIComponent children = null;
            UIComponent result = null;
            Iterator childrens = base.getFacetsAndChildren();
            while (childrens.hasNext() && (result == null)) {
                children = (UIComponent)childrens.next();
                if (id.equals(children.getId())) {
                    result = children;
                    break;
                }
                result = findComponent(children, id);
                if (result != null) {
                    break;
                }
            }
            return result;
        }
}
